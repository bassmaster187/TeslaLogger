{"version":3,"sources":["../src/trackmap_ctrl.js"],"names":["log","msg","L","moment","LegacyGraphHoverClearEvent","LegacyGraphHoverEvent","MetricsPanelCtrl","TrackMapCtrl","$scope","$injector","_","defaults","panel","maxDataPoints","autoZoom","scrollWheelZoom","defaultLayer","showLayerChanger","lineColor","pointColor","maxDataPointDelta","layers","tileLayer","attribution","maxZoom","forcedOverlay","subdomains","timeSrv","get","coords","leafMap","layerChanger","polylines","superchargerMarks","hoverMarker","hoverTarget","setSizePromise","events","on","onInitialized","bind","onViewModeChanged","onInitEditMode","onPanelTeardown","onPanelSizeChanged","onDataReceived","onDataSnapshotLoad","onRender","onRefresh","dashboard","type","onPanelHover","onPanelClear","eachLayer","l","GridLayer","isLoading","once","renderingCompleted","render","addEditorTab","$timeout","cancel","evt","length","target","Math","floor","pos","x","addTo","min","max","idx","exact","timestamp","setLatLng","position","removeFrom","map","invalidateSize","enabled","disable","enable","hadMap","Boolean","setupMap","layer","removeControl","addControl","addDataToMap","forEach","polyline","s","id","zoomSnap","zoomDelta","control","circleMarker","latLng","color","fillColor","fillOpacity","weight","radius","mapBaseLayerChange","mapZoomToBox","legend","onAdd","div","DomUtil","create","innerHTML","e","overlay","options","setZIndex","zIndex","bounds","reduce","t","c","boxZoomBounds","contains","from","to","Infinity","isFinite","setTime","utc","ap","coord","index","push","superchargerIcon","icon","iconUrl","iconAnchor","popupAnchor","p","marker","bindPopup","text","prevTimestamp","t2","mycolor","zoomToFit","getBounds","i","extend","isValid","fitBounds","setView","setStyle","data","columns","rows","row","txt","lats","datapoints","lons","types","snapshotData","templateUrl"],"mappings":"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","sourcesContent":["import L from './leaflet/leaflet.js';\r\nimport moment from 'moment';\r\n\r\nimport { LegacyGraphHoverClearEvent, LegacyGraphHoverEvent } from '@grafana/data';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\n\r\nimport './leaflet/leaflet.css!';\r\nimport './partials/module.css!';\r\n\r\nfunction log(msg) {\r\n  // uncomment for debugging\r\n  // console.log(msg);\r\n}\r\n\r\nexport class TrackMapCtrl extends MetricsPanelCtrl {\r\n  constructor($scope, $injector) {\r\n    super($scope, $injector);\r\n\r\n    log(\"constructor\");\r\n\r\n    _.defaults(this.panel, {\r\n      maxDataPoints: 500,\r\n      autoZoom: true,\r\n      scrollWheelZoom: false,\r\n      defaultLayer: 'OpenStreetMap',\r\n      showLayerChanger: true,\r\n      lineColor: 'red',\r\n      pointColor: 'royalblue',\r\n      maxDataPointDelta: 0,\r\n    });\r\n\r\n    // Save layers globally in order to use them in options\r\n    this.layers = {\r\n      'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n        attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>',\r\n        maxZoom: 19\r\n      }),\r\n      'OpenTopoMap': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {\r\n        attribution: 'Map data: &copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>, <a href=\"http://viewfinderpanoramas.org\">SRTM</a> | Map style: &copy; <a href=\"https://opentopomap.org\">OpenTopoMap</a> (<a href=\"https://creativecommons.org/licenses/by-sa/3.0/\">CC-BY-SA</a>)',\r\n        maxZoom: 17\r\n      }),\r\n      'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {\r\n        attribution: 'Imagery &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',\r\n        // This map doesn't have labels so we force a label-only layer on top of it\r\n        forcedOverlay: L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png', {\r\n          attribution: 'Labels by <a href=\"http://stamen.com\">Stamen Design</a>, <a href=\"http://creativecommons.org/licenses/by/3.0\">CC BY 3.0</a> &mdash; Map data &copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>',\r\n          subdomains: 'abcd',\r\n          maxZoom: 20,\r\n        })\r\n      })\r\n    };\r\n\r\n    this.timeSrv = $injector.get('timeSrv');\r\n    this.coords = [];\r\n    this.leafMap = null;\r\n    this.layerChanger = null;\r\n    this.polylines = [];\r\n    this.superchargerMarks = [];\r\n    this.hoverMarker = null;\r\n    this.hoverTarget = null;\r\n    this.setSizePromise = null;\r\n\r\n    // Panel events\r\n    this.events.on('panel-initialized', this.onInitialized.bind(this));\r\n    this.events.on('view-mode-changed', this.onViewModeChanged.bind(this));\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\r\n    this.events.on('panel-size-changed', this.onPanelSizeChanged.bind(this));\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n    this.events.on('data-snapshot-load', this.onDataSnapshotLoad.bind(this));\r\n    this.events.on('render', this.onRender.bind(this));\r\n    this.events.on('refresh', this.onRefresh.bind(this));\r\n\r\n    // Global events\r\n    this.dashboard.events.on(LegacyGraphHoverEvent.type, this.onPanelHover.bind(this), $scope);\r\n    this.dashboard.events.on(LegacyGraphHoverClearEvent.type, this.onPanelClear.bind(this), $scope);\r\n  }\r\n\r\n  onRefresh(){\r\n    log(\"onRefresh\");\r\n    this.onPanelSizeChanged();\r\n  }\r\n\r\n  onRender(){\r\n    //log(\"onRender\")\r\n\r\n    // Wait until there is at least one GridLayer with fully loaded\r\n    // tiles before calling renderingCompleted\r\n    if (this.leafMap) {\r\n      this.leafMap.eachLayer((l) => {\r\n        if (l instanceof L.GridLayer){\r\n          if (l.isLoading()) {\r\n            l.once('load', this.renderingCompleted.bind(this));\r\n          }\r\n          else {\r\n            this.renderingCompleted();\r\n          }\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  onInitialized(){\r\n    log(\"onInitialized\");\r\n    this.render();\r\n  }\r\n\r\n  onInitEditMode() {\r\n    log(\"onInitEditMode\");\r\n    this.addEditorTab('Options', 'public/plugins/pr0ps-trackmap-panel/partials/options.html', 2);\r\n  }\r\n\r\n  onPanelTeardown() {\r\n    log(\"onPanelTeardown\");\r\n    this.$timeout.cancel(this.setSizePromise);\r\n  }\r\n\r\n  onPanelHover(evt) {\r\n    // log(\"onPanelHover\");\r\n\r\n    if (this.coords.length === 0) {\r\n      return;\r\n    }\r\n\r\n    // check if we are already showing the correct hoverMarker\r\n    let target = Math.floor(evt.pos.x);\r\n    if (this.hoverTarget && this.hoverTarget === target) {\r\n      return;\r\n    }\r\n\r\n    // check for initial show of the marker\r\n    if (this.hoverTarget == null){\r\n      this.hoverMarker.addTo(this.leafMap);\r\n    }\r\n\r\n    this.hoverTarget = target;\r\n\r\n    // Find the currently selected time and move the hoverMarker to it\r\n    // Note that an exact match isn't always going to work due to rounding so\r\n    // we clean that up later (still more efficient)\r\n    let min = 0;\r\n    let max = this.coords.length - 1;\r\n    let idx = null;\r\n    let exact = false;\r\n    while (min <= max) {\r\n      idx = Math.floor((max + min) / 2);\r\n      if (this.coords[idx].timestamp === this.hoverTarget) {\r\n        exact = true;\r\n        break;\r\n      }\r\n      else if (this.coords[idx].timestamp < this.hoverTarget) {\r\n        min = idx + 1;\r\n      }\r\n      else {\r\n        max = idx - 1;\r\n      }\r\n    }\r\n\r\n    // Correct the case where we are +1 index off\r\n    if (!exact && idx > 0 && this.coords[idx].timestamp > this.hoverTarget) {\r\n      idx--;\r\n    }\r\n    this.hoverMarker.setLatLng(this.coords[idx].position);\r\n    this.render();\r\n  }\r\n\r\n  onPanelClear(evt) {\r\n    log(\"onPanelClear\");\r\n    // clear the highlighted circle\r\n    this.hoverTarget = null;\r\n    if (this.hoverMarker) {\r\n      this.hoverMarker.removeFrom(this.leafMap);\r\n    }\r\n  }\r\n\r\n  onViewModeChanged(){\r\n    log(\"onViewModeChanged\");\r\n    // KLUDGE: When the view mode is changed, panel resize events are not\r\n    //         emitted even if the panel was resized. Work around this by telling\r\n    //         the panel it's been resized whenever the view mode changes.\r\n    this.onPanelSizeChanged();\r\n  }\r\n\r\n  onPanelSizeChanged() {\r\n    log(\"onPanelSizeChanged\");\r\n    // KLUDGE: This event is fired too soon - we need to delay doing the actual\r\n    //         size invalidation until after the panel has actually been resized.\r\n    this.$timeout.cancel(this.setSizePromise);\r\n    let map = this.leafMap;\r\n    this.setSizePromise = this.$timeout(function(){\r\n      if (map) {\r\n        log(\"Invalidating map size\");\r\n        map.invalidateSize(true);\r\n      }}, 500\r\n    );\r\n  }\r\n\r\n  applyScrollZoom() {\r\n    let enabled = this.leafMap.scrollWheelZoom.enabled();\r\n    if (enabled != this.panel.scrollWheelZoom){\r\n      if (enabled){\r\n        this.leafMap.scrollWheelZoom.disable();\r\n      }\r\n      else{\r\n        this.leafMap.scrollWheelZoom.enable();\r\n      }\r\n    }\r\n  }\r\n\r\n  applyDefaultLayer() {\r\n    let hadMap = Boolean(this.leafMap);\r\n    this.setupMap();\r\n    if (hadMap){\r\n      // Re-add the default layer\r\n      this.leafMap.eachLayer((layer) => {\r\n        layer.removeFrom(this.leafMap);\r\n      });\r\n      this.layers[this.panel.defaultLayer].addTo(this.leafMap);\r\n\r\n      // Hide/show the layer switcher\r\n      this.leafMap.removeControl(this.layerChanger)\r\n      if (this.panel.showLayerChanger){\r\n        this.leafMap.addControl(this.layerChanger);\r\n      }\r\n    }\r\n    this.addDataToMap();\r\n  }\r\n\r\n  setupMap() {\r\n    log(\"setupMap\");\r\n    // Create the map or get it back in a clean state if it already exists\r\n    if (this.leafMap) {\r\n      if (this.polylines.length > 0){\r\n        this.polylines.forEach(polyline => polyline.removeFrom(this.leafMap));\r\n        this.polylines = [];\r\n      }\r\n\r\n      if (this.superchargerMarks.length > 0)\r\n      {\r\n        this.superchargerMarks.forEach(s => s.removeFrom(this.leafMap));\r\n        this.superchargerMarks = [];\r\n      }\r\n\r\n      this.onPanelClear();\r\n      return;\r\n    }\r\n\r\n    // Create the map\r\n    this.leafMap = L.map('trackmap-' + this.panel.id, {\r\n      scrollWheelZoom: this.panel.scrollWheelZoom,\r\n      zoomSnap: 0.5,\r\n      zoomDelta: 1,\r\n    });\r\n\r\n    // Create the layer changer\r\n    this.layerChanger = L.control.layers(this.layers)\r\n\r\n    // Add layers to the control widget\r\n    if (this.panel.showLayerChanger){\r\n      this.leafMap.addControl(this.layerChanger);\r\n    }\r\n\r\n    // Add default layer to map\r\n    this.layers[this.panel.defaultLayer].addTo(this.leafMap);\r\n\r\n    // Hover marker\r\n    this.hoverMarker = L.circleMarker(L.latLng(0, 0), {\r\n      color: 'white',\r\n      fillColor: this.panel.pointColor,\r\n      fillOpacity: 1,\r\n      weight: 2,\r\n      radius: 7\r\n    });\r\n\r\n    // Events\r\n    this.leafMap.on('baselayerchange', this.mapBaseLayerChange.bind(this));\r\n    this.leafMap.on('boxzoomend', this.mapZoomToBox.bind(this));\r\n\r\n    var legend = L.control({position: 'bottomleft'});\r\n      legend.onAdd = function (map) {\r\n        var div = L.DomUtil.create('div', 'leaflet-control-layers leaflet-control-layers-expanded');\r\n        div.innerHTML += '<span style=\"background-color: #CF3828; height: 3px; width: 20px; border-radius: 10%; display: inline-block;\"></span> Human driving<br>';\r\n        div.innerHTML += '<span style=\"background-color: #0070FF; height: 3px; width: 20px; border-radius: 10%; display: inline-block;\"></span> Autopilot / TACC';\r\n        return div;\r\n      };\r\n      legend.addTo(this.leafMap);\r\n  }\r\n\r\n  mapBaseLayerChange(e) {\r\n    // If a tileLayer has a 'forcedOverlay' attribute, always enable/disable it\r\n    // along with the layer\r\n    if (this.leafMap.forcedOverlay) {\r\n      this.leafMap.forcedOverlay.removeFrom(this.leafMap);\r\n      this.leafMap.forcedOverlay = null;\r\n    }\r\n    let overlay = e.layer.options.forcedOverlay;\r\n    if (overlay) {\r\n      overlay.addTo(this.leafMap);\r\n      overlay.setZIndex(e.layer.options.zIndex + 1);\r\n      this.leafMap.forcedOverlay = overlay;\r\n    }\r\n  }\r\n\r\n  mapZoomToBox(e) {\r\n    log(\"mapZoomToBox\");\r\n    // Find time bounds of selected coordinates\r\n    const bounds = this.coords.reduce(\r\n      function(t, c) {\r\n        if (e.boxZoomBounds.contains(c.position)) {\r\n          t.from = Math.min(t.from, c.timestamp);\r\n          t.to = Math.max(t.to, c.timestamp);\r\n        }\r\n        return t;\r\n      },\r\n      {from: Infinity, to: -Infinity}\r\n    );\r\n\r\n    // Set the global time range\r\n    if (isFinite(bounds.from) && isFinite(bounds.to)) {\r\n      // KLUDGE: Create moment objects here to avoid a TypeError that\r\n      //         occurs when Grafana processes normal numbers\r\n      this.timeSrv.setTime({\r\n        from: moment.utc(bounds.from),\r\n        to: moment.utc(bounds.to)\r\n      });\r\n    }\r\n    this.render();\r\n  }\r\n\r\n  // Add the circles and polyline to the map\r\n  addDataToMap() {\r\n    const coords = [[{\r\n      position: [],\r\n      ap: 0\r\n    }]];\r\n    var ap = 0;\r\n\r\n    this.coords.forEach((coord, index) => {\r\n      \r\n      if (ap != coord.ap)\r\n      {\r\n        coords[coords.length - 1][0].position.push(coord.position);\r\n\r\n        ap = coord.ap;\r\n        var t = {\r\n          position: [],\r\n          ap: ap\r\n        }\r\n\r\n        coords.push([t]); // Start a new polyline\r\n      }\r\n\r\n      if (coord.type == 1)\r\n      {\r\n        var superchargerIcon = L.icon({iconUrl: 'public/plugins/pr0ps-trackmap-panel/img/tesla_pin.png', iconAnchor:   [6, 16], popupAnchor:  [0, 0]});\r\n        var p = new L.latLng(coord.position);\r\n        var marker = new L.marker(p, {icon: superchargerIcon});\r\n        marker.bindPopup(coord.text);\r\n        marker.addTo(this.leafMap);\r\n        this.superchargerMarks.push(marker);\r\n      }\r\n      else if (coord.type == 2)\r\n      {\r\n        var superchargerIcon = L.icon({iconUrl: 'public/plugins/pr0ps-trackmap-panel/img/charger_pin.png', iconAnchor:   [6, 16], popupAnchor:  [0, 0]});\r\n        var p = new L.latLng(coord.position);\r\n        var marker = new L.marker(p, {icon: superchargerIcon});\r\n        marker.bindPopup(coord.text);\r\n        marker.addTo(this.leafMap);\r\n        this.superchargerMarks.push(marker);\r\n      }\r\n      else if (coord.type == 3)\r\n      {\r\n        var superchargerIcon = L.icon({iconUrl: 'public/plugins/pr0ps-trackmap-panel/img/ac_pin.png', iconAnchor:   [6, 16], popupAnchor:  [0, 0]});\r\n        var p = new L.latLng(coord.position);\r\n        var marker = new L.marker(p, {icon: superchargerIcon});\r\n        marker.bindPopup(coord.text);\r\n        marker.addTo(this.leafMap);\r\n        this.superchargerMarks.push(marker);\r\n      }\r\n      else if (coord.type == 4)\r\n      {\r\n        var superchargerIcon = L.icon({iconUrl: 'public/plugins/pr0ps-trackmap-panel/img/p_pin.png', iconAnchor:   [6, 16], popupAnchor:  [0, 0]});\r\n        var p = new L.latLng(coord.position);\r\n        var marker = new L.marker(p, {icon: superchargerIcon});\r\n        marker.bindPopup(coord.text);\r\n        marker.addTo(this.leafMap);\r\n        this.superchargerMarks.push(marker);\r\n      }\r\n      else if (index !== 0 && this.panel.maxDataPointDelta !== 0){\r\n        const prevTimestamp = this.coords[index - 1].timestamp;\r\n\r\n        if (coord.timestamp - prevTimestamp > this.panel.maxDataPointDelta * 1000){\r\n          var t2 = {\r\n            position: [],\r\n            ap: ap\r\n          }\r\n          coords.push([t2]); // Start a new polyline\r\n        }\r\n      }\r\n\r\n      coords[coords.length - 1][0].position.push(coord.position);\r\n    });\r\n\r\n    log(\"addDataToMap\");\r\n\r\n    coords.forEach((polyline, index) => {\r\n      log(\"polyline: \" + polyline.length + \" index\" + index);\r\n      //var c = coordsColor[index];\r\n      var mycolor = \"#0070FF\";\r\n      \r\n      if (polyline[0].ap != 1)\r\n        mycolor = \"#CF3828\";\r\n\r\n      this.polylines.push(L.polyline(polyline[0].position, {\r\n        color: mycolor,\r\n        weight: 3,\r\n      }).addTo(this.leafMap));\r\n    });\r\n\r\n    this.zoomToFit();\r\n  }\r\n\r\n  zoomToFit(){\r\n    log(\"zoomToFit\");\r\n    if (this.panel.autoZoom && this.polylines.length > 0){\r\n      var bounds = this.polylines[0].getBounds();\r\n\r\n      for (var i = 1; i < this.polylines.length; i++){\r\n        bounds = bounds.extend(this.polylines[i].getBounds());\r\n      }\r\n\r\n      if (bounds.isValid()){\r\n        this.leafMap.fitBounds(bounds);\r\n      }\r\n      else {\r\n        this.leafMap.setView([0, 0], 1);\r\n      }\r\n    }\r\n    this.render();\r\n  }\r\n\r\n  refreshPolylines() {\r\n    this.setupMap();\r\n    this.addDataToMap();\r\n  }\r\n\r\n  refreshColors() {\r\n    log(\"refreshColors\");\r\n    this.polylines.forEach(polyline => {\r\n      polyline.setStyle({ color: this.panel.lineColor });\r\n    });\r\n    if (this.hoverMarker){\r\n      this.hoverMarker.setStyle({\r\n        fillColor: this.panel.pointColor,\r\n      });\r\n    }\r\n    this.render();\r\n  }\r\n\r\n  onDataReceived(data) {\r\n    log(\"onDataReceived\");\r\n    this.setupMap();\r\n\r\n    this.coords.length = 0;\r\n\r\n    if (data[0].columns != null && data[0].rows != null)\r\n    {\r\n      log(\"Rows: \" + data[0].rows.length);\r\n\r\n      for (let i = 0; i < data[0].rows.length; i++) {\r\n      \r\n        var row = data[0].rows[i];\r\n\r\n        if (row[0] == null || row[1] == null || row[0] == 0 || row[1] == 0)\r\n          continue;\r\n\r\n        var t = null;\r\n        var txt = null;\r\n        if (true)\r\n        {\r\n          t = row[3];\r\n          if (t > 0)\r\n            txt = row[4];\r\n        }\r\n\r\n        this.coords.push({\r\n          position: L.latLng(row[1], row[2]),\r\n          timestamp: row[0],\r\n          type: t,\r\n          text: txt,\r\n          ap: row[5]\r\n        });\r\n      }\r\n\r\n      this.addDataToMap();\r\n      return;\r\n    }\r\n\r\n\r\n\r\n    if (data.length < 2) {\r\n      // No data or incorrect data, show a world map and abort\r\n      this.leafMap.setView([0, 0], 1);\r\n      this.render();\r\n      return;\r\n    }\r\n\r\n    \r\n    // begin time series\r\n\r\n    // Asumption is that there are an equal number of properly matched timestamps\r\n    // TODO: proper joining by timestamp?\r\n    this.coords.length = 0;\r\n    const lats = data[0].datapoints;\r\n    const lons = data[1].datapoints;\r\n    var types = null;\r\n    if (data.length > 2)\r\n      types = data[2].datapoints;\r\n\r\n    for (let i = 0; i < lats.length; i++) {\r\n      if (lats[i][0] == null || lons[i][0] == null ||\r\n          (lats[i][0] == 0 && lons[i][0] == 0) ||\r\n          lats[i][1] !== lons[i][1]) {\r\n        continue;\r\n      }\r\n\r\n      var t = null;\r\n      var txt = null;\r\n      if (types != null)\r\n      {\r\n        t = types[i][0];\r\n        txt = \"\";\r\n      }\r\n\r\n      this.coords.push({\r\n        position: L.latLng(lats[i][0], lons[i][0]),\r\n        timestamp: lats[i][1],\r\n        type: t,\r\n        text: txt\r\n      });\r\n    }\r\n    this.addDataToMap();\r\n    \r\n  }\r\n\r\n  onDataSnapshotLoad(snapshotData) {\r\n    log(\"onSnapshotLoad\");\r\n    this.onDataReceived(snapshotData);\r\n  }\r\n}\r\n\r\nTrackMapCtrl.templateUrl = 'partials/module.html';\r\n"],"file":"trackmap_ctrl.js"}